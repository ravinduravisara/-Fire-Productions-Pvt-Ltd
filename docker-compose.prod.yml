# Fire Productions Production Overrides

# Production overrides
services:
  postgres:
    deploy:
      resources:
        limits:
          memory: 512M

  server:
    deploy:
      resources:
        limits:
          memory: 256M
    env_file:
      - .env.production

  client:
    deploy:
      resources:
        limits:
          memory: 128M

  # PostgreSQL Backup Service
  postgres-backup:
    image: postgres:15
    container_name: fire-postgres-backup
    restart: "no"
    environment:
      PGPASSWORD: firepassword
    volumes:
      - ./postgres-backup:/backup
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        echo "Running PostgreSQL backup..."
        pg_dump -h postgres -U fire -d firedb -F c -f /backup/backup_$$(date +%Y%m%d_%H%M%S).dump
        echo "Cleaning old backups (keeping last 7 days)..."
        find /backup -maxdepth 1 -type f -name "backup_*.dump" -mtime +7 -exec rm -f {} \;
        echo "Backup complete!"
    networks:
      - fire-network
    profiles:
      - backup
